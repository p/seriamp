#!/usr/bin/env ruby

begin
  require 'sonamp'
rescue LoadError
  $: << File.join(File.dirname(__FILE__), '../lib')
  require 'sonamp'
end
require 'optparse'
require 'logger'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: sonamp [-d device] command arg..."

  opts.on("-d", "--device DEVICE", "TTY to use (default autodetect)") do |v|
    options[:device] = v
  end
end.parse!

logger = Logger.new(STDERR)
client = Sonamp::Client.new(options[:device], logger: logger)

cmd = ARGV.shift
unless cmd
  raise ArgumentError, "No command given"
end

def parse_on_off(value)
  case value&.downcase
  when '1', 'on', 'yes', 'true'
    true
  when '0', 'off', 'no', 'value'
    false
  else
    raise ArgumentError, "Invalid on/off value: #{value}"
  end
end

case cmd
when 'power'
  zone = ARGV.shift.to_i
  state = parse_on_off(ARGV.shift)
  client.power(zone, state)
when 'zvol'
  zone = ARGV.shift.to_i
  volume = ARGV.shift.to_i
  client.zone_volume(zone, volume)
when 'cvol'
  channel = ARGV.shift.to_i
  volume = ARGV.shift.to_i
  client.channel_volume(channel, volume)
when 'status'
  client.status
else
  raise ArgumentError, "Unknown command: #{cmd}"
end
